apiVersion: kubescape.io/v1
kind: Rules
metadata:
  name: kubescape-rules
  namespace: kubescape
  annotations:
    kubescape.io/namespace: kubescape
  labels:
    app: kubescape
spec:
  rules:
    - name: "Unexpected process launched"
      enabled: true
      id: "R0001"
      description: "Detects unexpected process launches that are not in the baseline"
      expressions:
        message: "'Unexpected process launched: ' + data.event.Comm + ' with PID ' + string(data.event.Pid)"
        unique_id: "data.event.Comm + '_' + string(data.event.Pid) + '_' + data.event.ExePath"
        rule_expression:
          - event_type: "exec"
            expression: "!ap.was_executed(data.event.Event.CommonData.Runtime.ContainerID, parse.get_exec_path(data.event.Args, data.event.Comm))"
      profile_dependency: 0
      severity: 1
      support_policy: false
      tags:
        - "anomaly"
        - "process"
        - "exec" 
        - "applicationprofile"
    - name: "Unexpected file access"
      enabled: true
      id: "R0002"
      description: "Detects unexpected file access that is not in the baseline"
      expressions:
        message: "'Unexpected file access detected: ' + data.event.Comm + ' with PID ' + string(data.event.Pid) + ' to ' + data.event.FullPath"
        unique_id: "data.event.Comm + '_' + data.event.FullPath"
        rule_expression:
          - event_type: "open"
            expression: "!ap.was_path_opened(data.event.Event.CommonData.Runtime.ContainerID, data.event.FullPath)"
      profile_dependency: 0
      severity: 1
      support_policy: false
      tags:
        - "anomaly"
        - "file"
        - "open"
        - "applicationprofile"
    - name: "Unexpected system call"
      enabled: true
      id: "R0003"
      description: "Detects unexpected system calls that are not whitelisted by application profile"
      expressions:
        message: "'Unexpected system call detected: ' + data.event.SyscallName + ' with PID ' + string(data.event.Pid)"
        unique_id: "data.event.SyscallName"
        rule_expression:
          - event_type: "syscall"
            expression: "!ap.was_syscall_used(data.event.Event.CommonData.Runtime.ContainerID, data.event.SyscallName)"
      profile_dependency: 0
      severity: 1
      support_policy: false
      tags:
        - "anomaly"
        - "syscall"
        - "applicationprofile"
    - name: "Unexpected capability used"
      enabled: true
      id: "R0004"
      description: "Detects unexpected capabilities that are not whitelisted by application profile"
      expressions:
        message: "'Unexpected capability used: ' + data.event.CapName + ' in syscall ' + data.event.Syscall + ' with PID ' + string(data.event.Pid)"
        unique_id: "data.event.Comm + '_' + data.event.CapName"
        rule_expression:
          - event_type: "capabilities"
            expression: "!ap.was_capability_used(data.event.Event.CommonData.Runtime.ContainerID, data.event.CapName)"
      profile_dependency: 0
      severity: 1
      support_policy: false
      tags:
        - "anomaly"
        - "capabilities"
        - "applicationprofile"
    - name: "Unexpected domain request"
      enabled: true
      id: "R0005"
      description: "Detecting unexpected domain requests that are not whitelisted by application profile."
      expressions:
        message: "'Unexpected domain communication: ' + data.event.DNSName + ' from: ' + data.event.Event.CommonData.K8s.BasicK8sMetadata.ContainerName"
        unique_id: "data.event.Comm + '_' + data.event.DNSName"
        rule_expression:
          - event_type: "dns"
            expression: "!nn.is_domain_in_egress(data.event.Event.CommonData.Runtime.ContainerID, data.event.DNSName) && !data.event.DNSName.endsWith('.svc.cluster.local.')"
      profile_dependency: 0
      severity: 1
      support_policy: false
      tags:
        - "dns"
        - "anomaly"
        - "networkprofile"
    - name: "Unexpected Service Account Token Access"
      enabled: true
      id: "R0006"
      description: "Detecting unexpected access to service account token."
      expressions:
        message: "'Unexpected access to service account token: ' + data.event.FullPath + ' with flags: ' + data.event.Flags.join(',')"
        unique_id: "data.event.Comm"
        rule_expression:
          - event_type: "open"
            expression: >
              (data.event.FullPath.startsWith('/run/secrets/kubernetes.io/serviceaccount') || 
               data.event.FullPath.startsWith('/var/run/secrets/kubernetes.io/serviceaccount') ||
               data.event.FullPath.startsWith('/run/secrets/eks.amazonaws.com/serviceaccount') ||
               data.event.FullPath.startsWith('/var/run/secrets/eks.amazonaws.com/serviceaccount')) &&
              !ap.was_path_opened_with_prefix(data.event.Event.CommonData.Runtime.ContainerID, '/run/secrets/kubernetes.io/serviceaccount') &&
              !ap.was_path_opened_with_prefix(data.event.Event.CommonData.Runtime.ContainerID, '/var/run/secrets/kubernetes.io/serviceaccount') &&
              !ap.was_path_opened_with_prefix(data.event.Event.CommonData.Runtime.ContainerID, '/run/secrets/eks.amazonaws.com/serviceaccount') &&
              !ap.was_path_opened_with_prefix(data.event.Event.CommonData.Runtime.ContainerID, '/var/run/secrets/eks.amazonaws.com/serviceaccount')
      profile_dependency: 1
      severity: 5
      support_policy: false
      tags:
        - "anomaly"
        - "serviceaccount"
        - "applicationprofile" 
    - name: "Kubernetes Client Executed"
      enabled: true
      id: "R0007"
      description: "Detecting execution of kubernetes client"
      expressions:
        message: "'Kubernetes client ' + data.event.Comm + ' was executed with PID ' + string(data.event.Pid)"
        unique_id: "data.event.Comm + '_' + data.event.Pcomm"
        rule_expression:
          - event_type: "exec"
            expression: "(data.event.Comm == 'kubectl' || data.event.ExePath.endsWith('/kubectl')) && !ap.was_executed(data.event.Event.CommonData.Runtime.ContainerID, parse.get_exec_path(data.event.Args, data.event.Comm))"
          - event_type: "network"
            expression: "data.event.PktType == 'OUTGOING' && k8s.is_api_server_address(data.event.DstEndpoint.Addr) && !nn.was_address_in_egress(data.event.Event.CommonData.Runtime.ContainerID, data.event.DstEndpoint.Addr)"
      profile_dependency: 0
      severity: 5 # Medium
      support_policy: false
      tags:
        - "exec"
        - "network"
        - "anomaly"
        - "applicationprofile"
    - name: "Read Environment Variables from procfs"
      enabled: true
      id: "R0008"
      description: "Detecting reading environment variables from procfs."
      expressions:
        message: "'Reading environment variables from procfs: ' + data.event.FullPath + ' by process ' + data.event.Comm"
        unique_id: "data.event.Comm + '_' + data.event.FullPath"
        rule_expression:
          - event_type: "open"
            expression: >
              data.event.FullPath.startsWith('/proc/') && 
              data.event.FullPath.endsWith('/environ') &&
              !ap.was_path_opened_with_suffix(data.event.Event.CommonData.Runtime.ContainerID, '/environ')
      profile_dependency: 0 # Required
      severity: 3
      support_policy: false
      tags:
        - "anomaly"
        - "procfs"
        - "environment"
        - "applicationprofile" 
    - name: "eBPF Program Load"
      enabled: true
      id: "R0009"
      description: "Detecting eBPF program load."
      expressions:
        message: "'bpf system call executed in ' + data.event.Event.CommonData.K8s.BasicK8sMetadata.ContainerName"
        unique_id: "data.event.Comm + '_' + data.event.SyscallName"
        rule_expression:
          - event_type: "syscall"
            expression: "data.event.SyscallName == 'bpf' && !ap.was_syscall_used(data.event.Event.CommonData.Runtime.ContainerID, data.event.SyscallName)"
      profile_dependency: 1
      severity: 5
      support_policy: false
      tags:
        - "syscall"
        - "ebpf" 
        - "applicationprofile"
    - name: "Unexpected Sensitive File Access"
      enabled: true
      id: "R0010"
      description: "Detecting access to sensitive files."
      expressions:
        message: "'Unexpected sensitive file access: ' + data.event.FullPath + ' by process ' + data.event.Comm"
        unique_id: "data.event.Comm + '_' + data.event.FullPath"
        rule_expression:
          - event_type: "open"
            expression: "data.event.FullPath.startsWith('/etc/shadow') && !ap.was_path_opened(data.event.Event.CommonData.Runtime.ContainerID, data.event.FullPath)"
      profile_dependency: 1
      severity: 5
      support_policy: false
      tags:
        - "files"
        - "anomaly"
        - "applicationprofile"
    - name: "Unexpected Egress Network Traffic"
      enabled: true
      id: "R0011"
      description: "Detecting unexpected egress network traffic that is not whitelisted by application profile."
      expressions:
        message: "'Unexpected egress network communication to: ' + data.event.DstEndpoint.Addr + ':' + string(data.event.Port) + ' using ' + data.event.Proto + ' from: ' + data.event.Event.CommonData.K8s.BasicK8sMetadata.ContainerName"
        unique_id: "data.event.DstEndpoint.Addr + '_' + string(data.event.Port) + '_' + data.event.Proto"
        rule_expression:
          - event_type: "network"
            expression: "data.event.PktType == 'OUTGOING' && !net.is_private_ip(data.event.DstEndpoint.Addr) && !nn.was_address_in_egress(data.event.Event.CommonData.Runtime.ContainerID, data.event.DstEndpoint.Addr)"
      profile_dependency: 0
      severity: 5 # Medium
      support_policy: false
      tags:
        - "whitelisted"
        - "network"
        - "anomaly"
        - "networkprofile" 
    - name: "Exec from malicious source"
      enabled: true
      id: "R1000"
      description: "Detecting exec calls that are from malicious source like: /dev/shm, /proc/self"
      expressions:
        message: "'Execution from malicious source: ' + data.event.ExePath + ' in directory ' + data.event.Cwd"
        unique_id: "data.event.Comm + '_' + data.event.ExePath + '_' + data.event.Pcomm"
        rule_expression:
          - event_type: "exec"
            expression: >
              (data.event.ExePath == '/dev/shm' || data.event.ExePath.startsWith('/dev/shm/')) ||
              (data.event.Cwd == '/dev/shm' || data.event.Cwd.startsWith('/dev/shm/'))
      profile_dependency: 2
      severity: 8
      support_policy: true
      tags:
        - "exec"
        - "signature"
        - "malicious" 
    - name: "Exec Binary Not In Base Image"
      enabled: true
      id: "R1001"
      description: "Detecting exec calls of binaries that are not included in the base image"
      expressions:
        message: "'Process (' + data.event.Comm + ') was executed and is not part of the image'"
        unique_id: "data.event.Comm + '_' + data.event.ExePath + '_' + data.event.Pcomm"
        rule_expression:
          - event_type: "exec"
            expression: >
              (data.event.UpperLayer == true ||
               data.event.PupperLayer == true) &&
              !ap.was_executed(data.event.Event.CommonData.Runtime.ContainerID, parse.get_exec_path(data.event.Args, data.event.Comm))
      profile_dependency: 1
      severity: 8
      support_policy: false
      tags:
        - "exec"
        - "malicious"
        - "binary"
        - "base image"
        - "applicationprofile" 
    - name: "Kernel Module Load"
      enabled: true
      id: "R1002"
      description: "Detecting Kernel Module Load."
      expressions:
        message: "'Kernel module load syscall (' + data.event.SyscallName + ') was called'"
        unique_id: "data.event.SyscallName"
        rule_expression:
          - event_type: "syscall"
            expression: >
              data.event.SyscallName == 'init_module' ||
              data.event.SyscallName == 'finit_module'
      profile_dependency: 2
      severity: 8
      support_policy: false
      tags:
        - "syscall"
        - "kernel"
        - "module"
        - "load" 
    - name: "Symlink Created Over Sensitive File"
      enabled: true
      id: "R1010"
      description: "Detects symlink creation over sensitive files"
      expressions:
        message: "'Symlink created over sensitive file: ' + data.event.OldPath + ' -> ' + data.event.NewPath"
        unique_id: "data.event.Comm + '_' + data.event.OldPath"
        rule_expression:
          - event_type: "symlink"
            expression: "(data.event.OldPath.startsWith('/etc/shadow') || data.event.OldPath.startsWith('/etc/sudoers')) && !ap.was_path_opened(data.event.Event.CommonData.Runtime.ContainerID, data.event.OldPath)"
      profile_dependency: 0
      severity: 5
      support_policy: true
      tags:
        - "anomaly"
        - "symlink" 
        - "applicationprofile"
